<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>📷 二維碼掃描及資料管理</title>
  <script src="https://unpkg.com/html5-qrcode" defer></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; padding:20px; }
    nav button { margin:5px; padding:8px 16px; border:none; border-radius:6px; background:#4CAF50; color:white; cursor:pointer; }
    nav button:hover { background:#45a049; }
    #reader, #readerQuery { max-width:350px; margin:auto; }
    #result, #latestText { background:#e0ffe0; margin-top:20px; padding:10px; border-radius:8px; }
    .tag-button { margin:5px; padding:8px 16px; border-radius:6px; border:1px solid #4CAF50; background:white; cursor:pointer; }
    .tag-button.active { background:#c8e6c9; }
    .tag-panel { margin-top:15px; }
  </style>
</head>
<body>
  <h2>📸 二維碼掃描及資料管理</h2>
  <nav>
    <button onclick="switchMode('scan')">掃描上傳</button>
    <button onclick="switchMode('query')">資料查詢</button>
    <button onclick="loadData('A4O-Tracking')">A4O資料</button>
    <button onclick="loadData('A4I-Tracking')">A4I資料</button>
    <button onclick="loadData('A4IO-Tracking')">A4IO資料</button>
  </nav>

  <!-- 掃描上傳 -->
  <div id="scanSection">
    <div id="reader"></div>
    <div id="tagButtons" style="margin-top:15px;"></div>
    <div id="tagPanel" class="tag-panel"></div>
    <div style="margin-top:10px;">
      <label>備註：</label>
      <input type="text" id="globalNote" placeholder="輸入備註" style="width:80%; padding:5px;">
    </div>
    <div id="result">掃描結果會顯示在這裡</div>
    <div class="spinner" id="loadingText"></div>
  </div>

  <!-- 資料查詢 -->
  <div id="querySection" style="display:none;">
    <div id="readerQuery"></div>
    <div id="latestText">掃描後顯示最新一筆文字</div>
    <div class="spinner" id="queryLoading"></div>
    <div id="queryTable"></div>
  </div>

  <!-- 其他 -->
  <div id="tableSection" style="display:none;">
    <h3 id="tableTitle">📄 資料列表</h3>
    <div id="dataList"></div>
  </div>

<script>
let lastScanned = "";
let currentMode = "scan";
const scriptUrl = "https://script.google.com/macros/s/AKfycbzgXD-I_Jlr32IZYoc6WX9waBFUwhvOKRZ0265yKt-g98llTZfJx__14kYEUjdXKIEl/exec";

let tagData = {};   // 標籤及選項
let selectedValues = {};  // 標籤選的值
let activeTag = "";       // 目前點擊的標籤

function loadTags() {
  fetch(${scriptUrl}?action=ItemList)
    .then(res => res.json())
    .then(data => {
      data.forEach(row => {
        const tag = row[0];
        const options = row.slice(1).filter(cell => cell !== "" && cell != null);
        tagData[tag] = options;
      });
      renderTagButtons();
    })
    .catch(err => console.error("讀取ItemList失敗", err));
}

function renderTagButtons() {
  const btnContainer = document.getElementById("tagButtons");
  btnContainer.innerHTML = "";
  Object.keys(tagData).forEach(tag => {
    btnContainer.innerHTML += <button class="tag-button" id="btn-${tag}" onclick="toggleTag('${tag}')">${tag}</button>;
  });
}

function toggleTag(tag) {
  activeTag = tag;

  // 更新按鈕狀態
  Object.keys(tagData).forEach(t => {
    const btn = document.getElementById(btn-${t});
    if (selectedValues[t]) {
      btn.style.background = "#c8e6c9";
    } else {
      btn.style.background = "white";
    }
  });
  document.getElementById(btn-${tag}).style.background = "#a5d6a7"; // active

  // 在固定面板顯示
  const panel = document.getElementById("tagPanel");
  let html = <label>${tag} 選項：</label><select id="select-${tag}"><option value="">請選擇</option>;
  tagData[tag].forEach(opt => {
    html += <option value="${opt}">${opt}</option>;
  });
  html += </select>;
  panel.innerHTML = html;

  // 如果有之前選擇過，就填入
  if (selectedValues[tag]) {
    document.getElementById(select-${tag}).value = selectedValues[tag];
  }

  // 綁定選擇事件
  document.getElementById(select-${tag}).onchange = (e) => {
    selectedValues[tag] = e.target.value;
    toggleTag(""); // 收起
  };
}

function onScanSuccess(decodedText) {
  if (decodedText === lastScanned) return;
  lastScanned = decodedText;

  // 把條碼內容存到 text，並且把其他標籤加到 note
  const noteContent = Object.keys(selectedValues)
    .map(tag => selectedValues[tag] ? ${tag}:${selectedValues[tag]} : "")
    .filter(val => val !== "").join(", ");

  const note = document.getElementById("globalNote").value;
  let finalNote = noteContent + (noteContent && note ? ", " : "") + note;

  const finalText = ${decodedText};

  document.getElementById('result').innerText = 📦 掃描成功：${finalText};
  document.getElementById('loadingText').innerText = "⬆️ 正在上傳...";
  fetch(${scriptUrl}?action=WriteData&text=${encodeURIComponent(finalText)}&note=${encodeURIComponent(finalNote)})
    .then(res => res.text())
    .then(msg => {
      document.getElementById('loadingText').innerText = ✅ 上傳成功：${msg};
      setTimeout(() => { lastScanned = ""; }, 3000);
    })
    .catch(err => {
      document.getElementById('loadingText').innerText = ❌ 上傳失敗：${err.message};
    });
}

function renderTable(targetDiv, data) {
  if (!Array.isArray(data) || data.length === 0) {
    targetDiv.innerHTML = "⚠️ 沒有資料";
    return;
  }
  if ($.fn.DataTable.isDataTable("#myTable")) {
    $("#myTable").DataTable().destroy();
    $("#myTable").empty();
  }
  let html = <table id="myTable" class="display"><thead><tr>;
  data[0].forEach((th) => html += <th>${th}</th>);
  html += </tr></thead><tbody>;
  data.slice(1).reverse().forEach(row => {
    html += <tr>;
    row.forEach(cell => { html += <td>${cell}</td>; });
    html += </tr>;
  });
  html += </tbody></table>;
  targetDiv.innerHTML = html;
  $("#myTable").DataTable({
    pageLength: 10,
    language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json" }
  });
}

function loadData(action) {
  document.getElementById("scanSection").style.display = "none";
  document.getElementById("querySection").style.display = "none";
  document.getElementById("tableSection").style.display = "block";
  document.getElementById("tableTitle").innerText = 📄 ${action.replace("-Tracking","")} 資料;
  const dataList = document.getElementById("dataList");
  dataList.innerHTML = "⌛ 載入中...";
  fetch(${scriptUrl}?action=${action})
    .then(res => res.json())
    .then(data => {
      if (!Array.isArray(data) || data.length === 0) {
        dataList.innerHTML = "⚠️ 沒有資料";
        return;
      }
      let html = <table id="dataTable" class="display"><thead><tr>;
      data[0].forEach((th) => html += <th>${th}</th>);
      html += </tr></thead><tbody>;
      data.slice(1).reverse().forEach(row => {
        html += <tr>;
        row.forEach(cell => { html += <td>${cell}</td>; });
        html += </tr>;
      });
      html += </tbody></table>;
      dataList.innerHTML = html;
      $("#dataTable").DataTable({
        pageLength: 10,
        language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json" }
      });
    })
    .catch(err => { dataList.innerHTML = ❌ 讀取失敗：${err.message}; });
}

function switchMode(mode) {
  currentMode = mode;
  if (mode === "scan") {
    document.getElementById("scanSection").style.display = "block";
    document.getElementById("querySection").style.display = "none";
    document.getElementById("tableSection").style.display = "none";
    scanner.render(onScanSuccess);
    scannerQuery.clear();
  } else if (mode === "query") {
    document.getElementById("scanSection").style.display = "none";
    document.getElementById("querySection").style.display = "block";
    document.getElementById("tableSection").style.display = "none";
    scannerQuery.render(onScanSuccess);
    scanner.clear();
  }
}

let scanner, scannerQuery;
window.onload = () => {
  loadTags();
  scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
  scannerQuery = new Html5QrcodeScanner("readerQuery", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
  scanner.render(onScanSuccess);
};
</script>
</body>
</html>
