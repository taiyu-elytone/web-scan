<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ“· äºŒç¶­ç¢¼æƒæåŠè³‡æ–™ç®¡ç†</title>
  <script src="https://unpkg.com/html5-qrcode" defer></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; padding:20px; }
    nav button { margin:5px; padding:8px 16px; border:none; border-radius:6px; background:#4CAF50; color:white; cursor:pointer; }
    nav button:hover { background:#45a049; }
    #reader, #readerQuery { max-width:350px; margin:auto; }
    #result, #latestText { background:#e0ffe0; margin-top:20px; padding:10px; border-radius:8px; }
    .tag-button { margin:5px; padding:8px 16px; border-radius:6px; border:1px solid #4CAF50; background:white; cursor:pointer; }
    .tag-button.active { background:#c8e6c9; }
    .tag-panel { display:none; margin:10px 0; }
    .tag-panel select, .tag-panel input { margin-top:5px; }
  </style>
</head>
<body>
  <h2>ğŸ“¸ äºŒç¶­ç¢¼æƒæåŠè³‡æ–™ç®¡ç†</h2>
  <nav>
    <button onclick="switchMode('scan')">æƒæä¸Šå‚³</button>
    <button onclick="switchMode('query')">è³‡æ–™æŸ¥è©¢</button>
    <button onclick="loadData('A4O-Tracking')">A4Oè³‡æ–™</button>
    <button onclick="loadData('A4I-Tracking')">A4Iè³‡æ–™</button>
    <button onclick="loadData('A4IO-Tracking')">A4IOè³‡æ–™</button>
  </nav>

  <!-- æƒæä¸Šå‚³ -->
  <div id="scanSection">
    <div id="reader"></div>
    <div id="tagSection"></div>
    <div id="result">æƒæçµæœæœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
    <div class="spinner" id="loadingText"></div>
  </div>

  <!-- è³‡æ–™æŸ¥è©¢ -->
  <div id="querySection" style="display:none;">
    <div id="readerQuery"></div>
    <div id="latestText">æƒæå¾Œé¡¯ç¤ºæœ€æ–°ä¸€ç­†æ–‡å­—</div>
    <div class="spinner" id="queryLoading"></div>
    <div id="queryTable"></div>
  </div>

  <!-- å…¶ä»– -->
  <div id="tableSection" style="display:none;">
    <h3 id="tableTitle">ğŸ“„ è³‡æ–™åˆ—è¡¨</h3>
    <div id="dataList"></div>
  </div>

<script>
let lastScanned = "";
let currentMode = "scan";
const scriptUrl = "https://script.google.com/macros/s/AKfycbzgXD-I_Jlr32IZYoc6WX9waBFUwhvOKRZ0265yKt-g98llTZfJx__14kYEUjdXKIEl/exec";

let tagData = {};   // å­˜æ¨™ç±¤é¸é …
let selectedTag = "";  // ç›®å‰é¸æ“‡çš„æ¨™ç±¤
let selectedValues = {}; // æ¨™ç±¤é¸çš„å…§å®¹
let noteValues = {};     // å‚™è¨»

function loadTags() {
  fetch(`${scriptUrl}?action=ItemList`)
    .then(res => res.json())
    .then(data => {
      // å…ˆæŠ“ç¬¬ä¸€æ¬„
      data.slice(2).forEach(row => {
        const tag = row[0];
        const options = row.slice(1).filter(cell => cell !== "" && cell != null);
        tagData[tag] = options;
      });
      renderTagUI();
    })
    .catch(err => console.error("è®€å–ItemListå¤±æ•—", err));
}

function renderTagUI() {
  const container = document.getElementById("tagSection");
  let html = "";
  Object.keys(tagData).forEach(tag => {
    html += `
    <div style="margin:5px;">
      <button class="tag-button" id="tagBtn-${tag}" onclick="toggleTag('${tag}')">${tag}</button>
      <div class="tag-panel" id="panel-${tag}">
        <select id="select-${tag}">
          <option value="">è«‹é¸æ“‡</option>
          ${tagData[tag].map(opt => `<option value="${opt}">${opt}</option>`).join("")}
        </select>
        <input id="note-${tag}" placeholder="å‚™è¨»">
      </div>
    </div>`;
  });
  container.innerHTML = html;
}

function toggleTag(tag) {
  // åªå…è¨±åŒæ™‚ä¸€å€‹å±•é–‹
  Object.keys(tagData).forEach(t => {
    document.getElementById(`panel-${t}`).style.display = (t === tag) ? "block" : "none";
  });
  selectedTag = tag;
}

function updateTagColor() {
  Object.keys(tagData).forEach(tag => {
    const sel = selectedValues[tag];
    if (sel && sel !== "") {
      document.getElementById(`tagBtn-${tag}`).style.background = "#c8e6c9"; // ç¶ 
    } else {
      document.getElementById(`tagBtn-${tag}`).style.background = "white";
    }
  });
}

function onScanSuccess(decodedText) {
  if (decodedText === lastScanned) return;
  lastScanned = decodedText;

  if (currentMode === "scan") {
    // æ”¶é›†ç›®å‰é¸çš„æ¨™ç±¤
    if (selectedTag) {
      const sel = document.getElementById(`select-${selectedTag}`).value;
      const note = document.getElementById(`note-${selectedTag}`).value;
      selectedValues[selectedTag] = sel;
      noteValues[selectedTag] = note;
    }
    updateTagColor();

    // çµ„åˆæ¨™ç±¤
    let extra = "";
    Object.keys(selectedValues).forEach(tag => {
      const val = selectedValues[tag];
      if (val) extra += `${tag}:${val}, `;
    });
    Object.keys(noteValues).forEach(tag => {
      const val = noteValues[tag];
      if (val) extra += `${tag}å‚™è¨»:${val}, `;
    });
    extra = extra.slice(0,-2);  // å»æ‰æœ€å¾Œé€—è™Ÿ

    const finalText = decodedText + (extra ? ` | ${extra}` : "");

    document.getElementById('result').innerText = `ğŸ“¦ æƒææˆåŠŸï¼š${finalText}`;
    document.getElementById('loadingText').innerText = "â¬†ï¸ æ­£åœ¨ä¸Šå‚³...";
    fetch(`${scriptUrl}?action=WriteData&text=${encodeURIComponent(finalText)}`)
      .then(res => res.text())
      .then(msg => {
        document.getElementById('loadingText').innerText = `âœ… ä¸Šå‚³æˆåŠŸï¼š${msg}`;
        setTimeout(() => { lastScanned = ""; }, 3000);
      })
      .catch(err => {
        document.getElementById('loadingText').innerText = `âŒ ä¸Šå‚³å¤±æ•—ï¼š${err.message}`;
      });
  } else if (currentMode === "query") {
    document.getElementById('queryLoading').innerText = "ğŸ” æ­£åœ¨æŸ¥è©¢...";
    fetch(`${scriptUrl}?action=DataFilter&filter=${encodeURIComponent(decodedText)}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('queryLoading').innerText = "";
        if (data.length > 0) {
          let lastRow = data[data.length - 1];
          document.getElementById('latestText').innerText = `æœ€æ–°ä¸€ç­†æ–‡å­—ï¼š${lastRow[1]}`;
          renderTable(document.getElementById("queryTable"), data);
        } else {
          document.getElementById('latestText').innerText = "âš ï¸ æ‰¾ä¸åˆ°ç¬¦åˆè³‡æ–™";
        }
        setTimeout(() => { lastScanned = ""; }, 3000);
      })
      .catch(err => {
        document.getElementById('queryLoading').innerText = `âŒ æŸ¥è©¢å¤±æ•—ï¼š${err.message}`;
      });
  }
}

function renderTable(targetDiv, data) {
  if (!Array.isArray(data) || data.length === 0) {
    targetDiv.innerHTML = "âš ï¸ æ²’æœ‰è³‡æ–™";
    return;
  }
  if ($.fn.DataTable.isDataTable("#myTable")) {
    $("#myTable").DataTable().destroy();
    $("#myTable").empty();
  }
  let html = `<table id="myTable" class="display"><thead><tr>`;
  data[0].forEach((th) => html += `<th>${th}</th>`);
  html += `</tr></thead><tbody>`;
  data.slice(1).reverse().forEach(row => {
    html += `<tr>`;
    row.forEach(cell => {
      html += `<td>${cell}</td>`;
    });
    html += `</tr>`;
  });
  html += `</tbody></table>`;
  targetDiv.innerHTML = html;
  $("#myTable").DataTable({
    pageLength: 10,
    language: {
      url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json"
    }
  });
}

function loadData(action) {
  document.getElementById("scanSection").style.display = "none";
  document.getElementById("querySection").style.display = "none";
  document.getElementById("tableSection").style.display = "block";
  const titleText = action.replace("-Tracking", "") + "è³‡æ–™";
  document.getElementById("tableTitle").innerText = `ğŸ“„ ${titleText}`;
  const dataList = document.getElementById("dataList");
  dataList.innerHTML = "âŒ› è¼‰å…¥ä¸­...";
  fetch(`${scriptUrl}?action=${action}`)
    .then(res => res.json())
    .then(data => {
      if (!Array.isArray(data) || data.length === 0) {
        dataList.innerHTML = "âš ï¸ æ²’æœ‰è³‡æ–™";
        return;
      }
      let html = `<table id="dataTable" class="display"><thead><tr>`;
      data[0].forEach((th) => html += `<th>${th}</th>`);
      html += `</tr></thead><tbody>`;
      data.slice(1).reverse().forEach(row => {
        html += `<tr>`;
        row.forEach(cell => {
          html += `<td>${cell}</td>`;
        });
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      dataList.innerHTML = html;
      $("#dataTable").DataTable({
        pageLength: 10,
        language: {
          url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json"
        }
      });
    })
    .catch(err => { dataList.innerHTML = `âŒ è®€å–å¤±æ•—ï¼š${err.message}`; });
}

function switchMode(mode) {
  currentMode = mode;
  if (mode === "scan") {
    document.getElementById("scanSection").style.display = "block";
    document.getElementById("querySection").style.display = "none";
    document.getElementById("tableSection").style.display = "none";
    scanner.render(onScanSuccess);
    scannerQuery.clear();
  } else if (mode === "query") {
    document.getElementById("scanSection").style.display = "none";
    document.getElementById("querySection").style.display = "block";
    document.getElementById("tableSection").style.display = "none";
    scannerQuery.render(onScanSuccess);
    scanner.clear();
  }
}

let scanner, scannerQuery;
window.onload = () => {
  loadTags();
  scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
  scannerQuery = new Html5QrcodeScanner("readerQuery", { fps: 10, qrbox: { width: 250, height: 250 } }, false);
  scanner.render(onScanSuccess);
};
</script>
</body>
</html>
