function doGet(e) {
  const action = e.parameter.action;
  const sheet = SpreadsheetApp.openById("11-W4ejr8rJnuvpswBxWmPTfKuKNS2Q6qPXOClxbR3D8");

  try {
    switch (action) {
      case "ItemList":
        return getItemList(sheet, e.parameter);
      case "DataList":
        return getDataList(sheet, e.parameter);
      case "DataFilter":
        return getDataFilter(sheet, e.parameter);
      case "WriteData":
        return getWriteData(sheet, e.parameter);
      case "A4I-Tracking":
      case "A4O-Tracking":
      case "A4IO-Tracking":
        return getGenericList(sheet, action);
      default:
        return jsonError("Unknown action");
    }
  } catch (err) {
    return jsonError(err.message);
  }
}

function getItemList(ss, param) {
  const sheet = ss.getSheetByName("ItemList");
  if (!sheet) return jsonError("Sheet ItemList 不存在");

  const data = sheet.getDataRange().getValues();
  return jsonSuccess(data);
}

function getDataList(ss, param) {
  const sheet = ss.getSheetByName("Tracking Record");
  if (!sheet) return jsonError("Sheet Tracking Record 不存在");

  const data = sheet.getDataRange().getValues();
  return jsonSuccess(data);
}

function getDataFilter(ss, param) {
  const sheet = ss.getSheetByName("Tracking Record");
  if (!sheet) return jsonError("Sheet Tracking Record 不存在");

  const keyword = param.filter || "";
  const data = sheet.getDataRange().getValues();
  
  const header = ["日期", "備註"];
  const filtered = [];
  filtered.push(header);

  data.forEach((row, idx) => {
    if (idx === 0) return;  // skip sheet header
    if (row[1] && row[1].toString() === keyword) {
      filtered.push([row[0], row[2]]);
    }
  });

  return jsonSuccess(filtered);
}

function getWriteData(ss, param) {
  const sheet = ss.getSheetByName("Tracking Record");
  if (!sheet) return jsonError("Sheet Tracking Record 不存在");

  const text = param.text || "";
  if (!text) return jsonError("text 參數必填");

  const note = param.note || "";
  const now = new Date();
  const formatted = Utilities.formatDate(now, "Asia/Taipei", "yyyy-MM-dd HH:mm:ss");

  sheet.appendRow([formatted, text, note]);
  return jsonSuccess({ message: `已寫入 ${text}` });
}

function getGenericList(ss, sheetName) {
  const sheet = ss.getSheetByName(sheetName);
  if (!sheet) return jsonError(`Sheet ${sheetName} 不存在`);

  const data = sheet.getDataRange().getValues();
  const filtered = data
    .filter(row => row.some(cell => cell !== "" && cell !== null && cell !== undefined))
    .map(row => {
      let newRow = [...row];
      newRow.splice(2, 2); // remove C,D
      return newRow;
    });

  return jsonSuccess(filtered);
}

// 共用回傳 JSON
function jsonSuccess(data) {
  return ContentService
    .createTextOutput(JSON.stringify({ status: "success", data }))
    .setMimeType(ContentService.MimeType.JSON);
}

function jsonError(message) {
  return ContentService
    .createTextOutput(JSON.stringify({ status: "error", message }))
    .setMimeType(ContentService.MimeType.JSON);
}
