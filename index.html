function onScanSuccess(decodedText) {
  if (decodedText === lastScanned) return;
  lastScanned = decodedText;

  if (currentMode === "scan") {
    document.getElementById('result').innerText = `ğŸ“¦ æƒææˆåŠŸï¼š${decodedText}`;
    document.getElementById('loadingText').innerText = "â¬†ï¸ æ­£åœ¨ä¸Šå‚³...";
    fetch(`${scriptUrl}?action=WriteData&text=${encodeURIComponent(decodedText)}`)
      .then(res => {
        if (!res.ok) throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${res.status}`);
        return res.text();
      })
      .then(msg => {
        document.getElementById('loadingText').innerText = `âœ… ä¸Šå‚³æˆåŠŸï¼š${msg}`;
        setTimeout(() => { lastScanned = ""; }, 3000);
      })
      .catch(err => {
        document.getElementById('loadingText').innerText = `âŒ ä¸Šå‚³å¤±æ•—ï¼š${err.message}`;
      });
  } else if (currentMode === "query") {
    document.getElementById('queryLoading').innerText = "ğŸ” æ­£åœ¨æŸ¥è©¢...";
    fetch(`${scriptUrl}?action=DataFilter&filter=${encodeURIComponent(decodedText)}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('queryLoading').innerText = "";
        if (data.length > 0) {
          let lastRow = data[data.length - 1];
          document.getElementById('latestText').innerText = `æœ€æ–°ä¸€ç­†æ–‡å­—ï¼š${lastRow[1]}`;
          renderTable(document.getElementById("queryTable"), data);
        } else {
          document.getElementById('latestText').innerText = "âš ï¸ æ‰¾ä¸åˆ°ç¬¦åˆè³‡æ–™";
        }
        setTimeout(() => { lastScanned = ""; }, 3000);
      })
      .catch(err => {
        document.getElementById('queryLoading').innerText = `âŒ æŸ¥è©¢å¤±æ•—ï¼š${err.message}`;
      });
  }
}
