function onScanSuccess(decodedText) {
  if (decodedText === lastScanned) return;
  lastScanned = decodedText;

  if (currentMode === "scan") {
    document.getElementById('result').innerText = `📦 掃描成功：${decodedText}`;
    document.getElementById('loadingText').innerText = "⬆️ 正在上傳...";
    fetch(`${scriptUrl}?action=WriteData&text=${encodeURIComponent(decodedText)}`)
      .then(res => {
        if (!res.ok) throw new Error(`伺服器錯誤: ${res.status}`);
        return res.text();
      })
      .then(msg => {
        document.getElementById('loadingText').innerText = `✅ 上傳成功：${msg}`;
        setTimeout(() => { lastScanned = ""; }, 3000);
      })
      .catch(err => {
        document.getElementById('loadingText').innerText = `❌ 上傳失敗：${err.message}`;
      });
  } else if (currentMode === "query") {
    document.getElementById('queryLoading').innerText = "🔍 正在查詢...";
    fetch(`${scriptUrl}?action=DataFilter&filter=${encodeURIComponent(decodedText)}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('queryLoading').innerText = "";
        if (data.length > 0) {
          let lastRow = data[data.length - 1];
          document.getElementById('latestText').innerText = `最新一筆文字：${lastRow[1]}`;
          renderTable(document.getElementById("queryTable"), data);
        } else {
          document.getElementById('latestText').innerText = "⚠️ 找不到符合資料";
        }
        setTimeout(() => { lastScanned = ""; }, 3000);
      })
      .catch(err => {
        document.getElementById('queryLoading').innerText = `❌ 查詢失敗：${err.message}`;
      });
  }
}
